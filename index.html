<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="菜鸟的逆袭">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="菜鸟的逆袭">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="菜鸟的逆袭">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>菜鸟的逆袭</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">菜鸟的逆袭</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/node-v8-metrics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/10/node-v8-metrics/" itemprop="url">node_v8_metrics</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-10T10:19:06+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="node-v8-内存一二三"><a href="#node-v8-内存一二三" class="headerlink" title="node v8 内存一二三"></a>node v8 内存一二三</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ul>
<li><p>Node.js 进程的内存管理，都是有<code>V8</code>自动处理的，包括内存分配和释放。</p>
</li>
<li><p>在<code>V8</code>内部，会为程序中的所有变量构建一个图，来表示变量间的关联关系，当变量从根节点无法触达时，就意味着这个变量不会再被使用了，即可回收。</p>
</li>
<li><p>回收是一个过程性的，从快速<code>GC</code>到最后的<code>Full GC</code>，是需要一段时间的。另外，<code>Full GC</code>是有触发阈值的，所以可能会出现内存长期占用在一个高值，也可以算是一种内存泄漏。还有一种就是引用不释放，导致无法进入<code>GC</code>环节，并且一直产生新的占用，这一般会发生在<code>Javascript</code>业务层面。</p>
</li>
<li><p>定位内存泄漏，找有引用但不被使用</p>
</li>
</ul>
<h2 id="V8-内存构成"><a href="#V8-内存构成" class="headerlink" title="V8 内存构成"></a><code>V8</code> 内存构成</h2><h3 id="一个-V8-进程的内存通常由以下几个块构成："><a href="#一个-V8-进程的内存通常由以下几个块构成：" class="headerlink" title="一个 V8 进程的内存通常由以下几个块构成："></a>一个 <code>V8</code> 进程的内存通常由以下几个块构成：</h3><p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/EEDD6D86E59B4B209EC468D45DAA0FE1/6020" alt="v8内存内部模块"></p>
<p><code>node-v8</code> 暴露模块</p>
<ul>
<li>新生代内存区（<code>new_space</code>）<ul>
<li>大多数的对象都会被分配在这里，这个区域很小但是垃圾回收比较频繁</li>
</ul>
</li>
<li>老生代内存区（<code>old_space</code>）<ul>
<li>属于老生代，这里只保存原始数据对象，这些对象没有指向其他对象的指针</li>
</ul>
</li>
<li>大对象区（<code>large_object_space</code>）<ul>
<li>这里存放体积超越其他区大小的对象，每个对象有自己的内存，垃圾回收其不会移动大对象区</li>
</ul>
</li>
<li>代码区（<code>code_space</code>）<ul>
<li>代码对象，会被分配在这里。唯一拥有执行权限的内存</li>
</ul>
</li>
<li>map 区（<code>map_space</code>）<ul>
<li>存放 <code>Cell</code> 和 <code>Map</code>，每个区域都是存放相同大小的元素，结构简单</li>
</ul>
</li>
</ul>
<h3 id="内存分布"><a href="#内存分布" class="headerlink" title="内存分布"></a>内存分布</h3><p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/WEBRESOURCEf08ab39a9603ea46e081ef85cd1ad59a/5986" alt="内存分布"></p>
<p>内存模块中通常分为已申请区、使用区、可使用区等。<code>new_space</code>则分为激活区、未激活区。</p>
<p>以下通过三个API获取的当前系统及程序内存环境数据，已换算成<code>MB</code></p>
<ul>
<li><code>process.memoryUsage()</code></li>
<li><code>v8.getHeapStatistics()</code></li>
<li><code>v8.getHeapSpaceStatistics()</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">100000</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"memoryUsage"</span>: &#123;</span><br><span class="line">      <span class="attr">"rss"</span>: <span class="number">217</span>,</span><br><span class="line">      <span class="attr">"heapTotal"</span>: <span class="number">181</span>,</span><br><span class="line">      <span class="attr">"heapUsed"</span>: <span class="number">152</span>,</span><br><span class="line">      <span class="attr">"external"</span>: <span class="number">11</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"HeapStatistics"</span>: &#123;</span><br><span class="line">      <span class="attr">"total_heap_size"</span>: <span class="number">181</span>,</span><br><span class="line">      <span class="attr">"total_heap_size_executable"</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">"total_physical_size"</span>: <span class="number">179</span>,</span><br><span class="line">      <span class="attr">"total_available_size"</span>: <span class="number">1260</span>,</span><br><span class="line">      <span class="attr">"used_heap_size"</span>: <span class="number">152</span>,</span><br><span class="line">      <span class="attr">"heap_size_limit"</span>: <span class="number">1432</span>,</span><br><span class="line">      <span class="attr">"malloced_memory"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"peak_malloced_memory"</span>: <span class="number">11</span>,</span><br><span class="line">      <span class="attr">"does_zap_garbage"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"HeapSpaceStatistics"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"space_name"</span>: <span class="string">"new_space"</span>,</span><br><span class="line">        <span class="attr">"space_size"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"space_used_size"</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="attr">"space_available_size"</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="attr">"physical_space_size"</span>: <span class="number">32</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"space_name"</span>: <span class="string">"old_space"</span>,</span><br><span class="line">        <span class="attr">"space_size"</span>: <span class="number">88</span>,</span><br><span class="line">        <span class="attr">"space_used_size"</span>: <span class="number">86</span>,</span><br><span class="line">        <span class="attr">"space_available_size"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"physical_space_size"</span>: <span class="number">88</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"space_name"</span>: <span class="string">"code_space"</span>,</span><br><span class="line">        <span class="attr">"space_size"</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="attr">"space_used_size"</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="attr">"space_available_size"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"physical_space_size"</span>: <span class="number">9</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"space_name"</span>: <span class="string">"map_space"</span>,</span><br><span class="line">        <span class="attr">"space_size"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"space_used_size"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"space_available_size"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"physical_space_size"</span>: <span class="number">3</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"space_name"</span>: <span class="string">"large_object_space"</span>,</span><br><span class="line">        <span class="attr">"space_size"</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="attr">"space_used_size"</span>: <span class="number">49</span>,</span><br><span class="line">        <span class="attr">"space_available_size"</span>: <span class="number">1250</span>,</span><br><span class="line">        <span class="attr">"physical_space_size"</span>: <span class="number">50</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"msg"</span>: <span class="string">"metrics"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="v8内存生命周期"><a href="#v8内存生命周期" class="headerlink" title="v8内存生命周期"></a>v8内存生命周期</h3><p>假设当前有一个变量<code>house</code>，从创建到销毁过程大致过程如下。</p>
<ol>
<li><p>这个对象被分配到了 <code>new_space</code></p>
</li>
<li><p>随着程序的运行，<code>new_space</code> 塞满了，<code>GC</code> 开始清理 <code>new_space</code> 里的<code>死</code>对象，<code>house</code> 因为还处于活跃状态，所以没被清理出去<code>GC</code></p>
</li>
<li><p>清理了两遍 <code>new_space</code>，发现 <code>house</code> 依然还活跃着，就把 <code>house</code> 移动到了 <code>old_space</code></p>
</li>
<li><p>随着程序的运行，<code>old_space</code> 也塞满了，<code>GC</code> 开始清理 <code>old_space</code>，这时候发现 <code>house</code> 已经没有被引用了，就把 <code>house</code> 给清理出去了，如果一直引用，则不会被清理</p>
</li>
</ol>
<p>第二步里，清理 <code>new_space</code> 的过程叫做 <code>Scavenge</code>（不是胡说八道，证据在上面源码图里），即空间换时间，我们把<code>new_space</code>分为激活和未激活两个区域，则过程如下：</p>
<p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/WEBRESOURCE97aa6f5f60545b3487162ee02e2c218a/6010" alt="scavenge策略"></p>
<ol>
<li>当活跃区满了之后，交换活跃区和非活跃区，交换后活跃区变空</li>
<li>将非活跃区的两次清理都没清理出去的对象移动到 <code>old_space</code></li>
<li>将还没清理够两次的但是活跃状态的对象移动到活跃区</li>
</ol>
<p>第四步里，清理 <code>old_space</code> 的过程叫做 <code>Mark-sweep</code> ，这块占用内存很大，所以没有使用 <code>Scavenge</code>，这个回收过程包含了若干次标记过程和清理过程：</p>
<p>把当前 <code>内存数据抽象为森林</code>，如下<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/WEBRESOURCE5a2834d9b2313bfb0446b8985afd390b/6013" alt="mark-sweep"></p>
<p>清理后<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/WEBRESOURCEb432ed0f3ba86d2d65097d1fa0e15e83/6016" alt="mark-sweep"></p>
<ol>
<li>标记从根可达的对象为黑色</li>
<li>遍历黑色对象的邻接对象，直到所有对象都标记为黑色</li>
<li>循环标记若干次</li>
<li>清理掉非黑色的对象。</li>
</ol>
<p>简单来说，<code>Mark-sweep</code> 就是把从根节点无法获取到的对象清理掉</p>
<h3 id="理论于实践的意义"><a href="#理论于实践的意义" class="headerlink" title="理论于实践的意义"></a>理论于实践的意义</h3><p>注：本文Chrome调试部分基于版本（Version <code>74.0.3729.169</code> (Official Build) (64-bit)）</p>
<h4 id="首先认识下Chrome-DevTools内存模块（当前静态内存分布，时刻）"><a href="#首先认识下Chrome-DevTools内存模块（当前静态内存分布，时刻）" class="headerlink" title="首先认识下Chrome DevTools内存模块（当前静态内存分布，时刻）"></a>首先认识下<code>Chrome DevTools</code>内存模块（当前静态内存分布，时刻）</h4><ul>
<li>准备好 <code>Chrome</code>，然后执行下面的代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeikeClass</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(super)&#123;</span><br><span class="line">    <span class="keyword">this</span>.super()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeikeFangClass</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.fang = <span class="keyword">new</span> BeikeClass()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">100000</span>).fill(<span class="string">''</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;<span class="keyword">new</span> BeikeFangClass()&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>打开<code>Chrome devtools</code>，进入<code>memory</code></li>
</ul>
<p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/D28AC58CB6AC4269AC28E0C271A6D7DC/6018" alt="内存堆快照"></p>
<p>介绍下几个tab:</p>
<ul>
<li><code>Constructor</code>为构造函数</li>
<li><code>Distance</code>为对象到根层级</li>
<li><code>Shallow Size</code>为对象自己内存大小（不包含内部引用）</li>
<li><code>Retained Size</code>为对象内存总大小且包含内部引用对象大小</li>
</ul>
<p>上面经过过滤后会看到申明的两个类 <code>BeikeClass</code>、<code>BeikeFangClass</code>，可以看到 <code>BeikeFangClass</code>(6)下一层级有 <code>BeikeClass</code>(7)，而且 <code>2400000+3200000=5600000</code> 也符合上面对 <code>Shallow Size</code>和 <code>Retained Size</code>的解释（瞎解释？，<a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101" target="_blank" rel="noopener">官网走你</a>）</p>
<p>注：<code>Retained Size</code> 是性能调优阶段重要指标（主动<code>GC</code>）</p>
<h4 id="怎么样才能看到内存在涨呢？看个动态的Performance之前叫Timeline"><a href="#怎么样才能看到内存在涨呢？看个动态的Performance之前叫Timeline" class="headerlink" title="怎么样才能看到内存在涨呢？看个动态的Performance之前叫Timeline"></a>怎么样才能看到内存在涨呢？看个动态的<code>Performance</code>之前叫<code>Timeline</code></h4><p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/DD4B05DF897243D58305540F4B77006B/6026" alt="`Performance`"></p>
<p>看，这里的<code>波动图</code>就能看到内存在涨。怎么操作？执行下面的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">grow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'div'</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  x.push(<span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1000000</span>).join(<span class="string">'x'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'grow'</span>).addEventListener(<span class="string">'click'</span>, grow);</span><br></pre></td></tr></table></figure>
<p>然后点击开始记录当前时刻开始一段时间内的内存使用情况，下面仔细看下这20s左右内存使用情况：</p>
<ul>
<li><p>首先主动<code>GC</code>一次，能看到内存有所下降，也就是图中标注的第一次（<code>Major GC</code>，其中可能包含一到多次<code>Minor GC</code>），<code>Major GC</code>通常是针对老生代、<code>Minor GC</code>通常针对新生代，那也就意味着<code>Major</code>通常比<code>Minor</code>慢，因为老生代内存比新生代内存大很多，算法也不相同。</p>
</li>
<li><p>中间红色框标记的为向文档中插入<code>10000</code>个DOM，可以看到<code>js heap</code>有增长</p>
</li>
<li><p>后续每次插入<code>10000</code>DOM，都能看到明显的<code>js heap</code>增长，同时还有<code>nodes</code>增长</p>
</li>
<li><p>在随着DOM原来越多，系统会自动触发<code>DOM GC</code>，尝试回收无用DOM，以及<code>Minor GC</code><br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/0681504A22D648B4A88CDA9728E8B098/6030" alt="DOM"><br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/3DC318AD5F2E44109C7C2BE490CFCF1F/6028" alt="DOM"></p>
</li>
<li><p>最后一次主动GC后内存也明显下降了</p>
</li>
<li><p>我们还可以点击下方的 <code>Call tree</code> 来查看整个过程的调用树，我们能看到除<code>Major GC</code>、<code>Minor GC</code>、<code>DOM GC</code>之外的其他相关系统调用栈及具体信息<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/6DE35BD1EFB34650A0DCC14E86E358B5/6032" alt="Call Tree"></p>
</li>
<li><p>通过<code>Event Log</code>查看根据时间系统调用栈<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/B0D600F46EC84AE0B2EA62077044AE36/6034" alt="`Event Log`"></p>
</li>
</ul>
<h4 id="怎么分析内存爆了？谁爆了？"><a href="#怎么分析内存爆了？谁爆了？" class="headerlink" title="怎么分析内存爆了？谁爆了？"></a>怎么分析内存爆了？谁爆了？</h4><p>那我们模拟一个泄漏的例子，模拟内存增长：</p>
<ul>
<li><p>打开 <code>memory</code>，然后执行下面的代码，每隔一段时间录制一段 <code>HEAP SNAPSHOTS</code>，然后做两两对比<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/22B677705A284D0B87C0A4DA9019E6D7/6036" alt="`多次HEAP SNAPSHOTS`"></p>
</li>
<li><p>对于上面的图来说，我们的首先选中其中一个<code>SNAPSHOTS</code>比如<code>SNAPSHOTS 7</code>，然后修改<code>Summary-&gt;Comparison</code>，右侧选中<code>SNAPSHOTS 7</code>作对比，我们看到右侧红色框中<code>new</code>中比较多，也是我们需要关注的。</p>
</li>
<li><p>重复上面的过程，选择对比<code>SNAPSHOTS 8</code>与<code>SNAPSHOTS 7</code>，同样能得到一个对比<br><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/9A5F41838121412093042EDBBA949FE9/6038" alt="二次对比"></p>
</li>
<li><p>对比两张图，可以看到两次对比中<code>BeikeClass</code>、<code>ArrayBuffer</code>、<code>string</code>等几项都明显增长，我们点击三角展开就能定位变量最终引用比如这里的<code>ArrayBuffer</code>，点开后<code>fang in BeikeiClass</code>-<code>1560244861634</code>-<code>_heap</code>，及最终引用链（官网叫支配项）</p>
</li>
<li><p><img src="https://note.youdao.com/yws/public/resource/799fa86e722c8006d116c6c667bf4d8e/xmlnote/9CF730B61DDB43AF828E6AF4185B1D50/6040" alt="对象引用"></p>
</li>
</ul>
<p>最终我们也就能定位到是<code>BeikeClass</code>、<code>ArrayBuffer</code>、<code>string</code>几个可能是‘<code>凶手</code>’，从而破案。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/我是怎样搞定webpack4静态资源的/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/我是怎样搞定webpack4静态资源的/" itemprop="url">我是怎样搞定webpack4静态资源的</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-08T12:10:08+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="这篇文章说说webpack的静态资源"><a href="#这篇文章说说webpack的静态资源" class="headerlink" title="这篇文章说说webpack的静态资源"></a>这篇文章说说webpack的静态资源</h3><h4 id="前端工程化"><a href="#前端工程化" class="headerlink" title="前端工程化"></a>前端工程化</h4><blockquote>
<p>提到前端工程化，现在大家避免不开的可能就是webpack了，那webpack经历了多个版本，不同版本之间差异也是比较折磨人的。</p>
</blockquote>
<blockquote>
<p>笔者经历过（使用）三个大版本，<code>webpack2.x webpack3.x webpack4.x</code>，现在大家用得最多的也就是4.x了，因为4.x支持按需加载了，这就很厉害了呀，既然能按需加载，那肯定涉及到代码的拆分，当然拆分是webpack自己做的，是否启用按需加载这是个也是我们自己配置决定的，</p>
</blockquote>
<p>未完（没空写）</p>
<p>自定义了一个工具 <a href="https://www.npmjs.com/package/@schacker/hpack-cli" target="_blank" rel="noopener">hpack直通车</a>，有兴趣的可以先看</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/XHR原生对象到底怎么仿AJAX？/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/XHR原生对象到底怎么仿AJAX？/" itemprop="url">XHR原生对象到底怎么仿AJAX？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-08T10:12:56+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="XHR（XMLHttpRequest）"><a href="#XHR（XMLHttpRequest）" class="headerlink" title="XHR（XMLHttpRequest）"></a>XHR（XMLHttpRequest）</h3><p>— <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener">MDN文档</a></p>
<p>XHR是浏览器提供的能与服务端进行信息交互的对象，支持多种协议。</p>
<p>此接口继承了 XMLHttpRequestEventTarget 和 EventTarget 的属性。</p>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><blockquote>
<p>MLHttpRequest.onreadystatechange</p>
</blockquote>
<ul>
<li>当readyState属性发生变化时调用的EventHandler。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.readyState 只读</p>
</blockquote>
<ul>
<li>返回 一个unsigned short 即无符号短整型，请求的状态码。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.response 只读</p>
</blockquote>
<ul>
<li>返回ArrayBuffer、Blob、Document、DOMString}，具体是哪种类型取决于<br>XMLHttpRequest.responseType的值。其中包含响应体body。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.responseText 只读</p>
</blockquote>
<ul>
<li>返回一个DOMString}，该DOMString}包含对请求的响应，如果请求未成功或尚未发送，则返回null。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.responseType</p>
</blockquote>
<ul>
<li>定义响应类型的枚举值。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.responseURL 只读</p>
</blockquote>
<ul>
<li>返回响应的序列化URL，如果URL为空，则返回空字符串。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.responseXML 只读  Not available to workers</p>
</blockquote>
<ul>
<li>返回一个Document，其中包含该请求的响应，如果请求未成功、尚未发送或不能解析为XML或HTML，则返回null。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.status 只读</p>
</blockquote>
<ul>
<li>返回  unsigned short 即无符号短整型请求响应状态。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.statusText 只读</p>
</blockquote>
<ul>
<li>返回一个DOMString}，其中包含HTTP服务器返回的响应状态。与 XMLHTTPRequest.status不同的是，它包括响应状态的整个文本(例如，“200 OK”)。</li>
</ul>
<p>注意：根据HTTP/2规范(8.1.2.4响应伪标头字段)，HTTP/2没有定义一种方式来携带HTTP/1.1状态行中包含的版本或原因短语。</p>
<blockquote>
<p>XMLHttpRequest.timeout</p>
</blockquote>
<ul>
<li>unsigned long 即无符号长整型，表示该请求的最大请求时间（毫秒），超过该时间请求会自动结束。</li>
</ul>
<blockquote>
<p>XMLHttpRequestEventTarget.ontimeout</p>
</blockquote>
<ul>
<li>当请求超时调用的EventHandler。{ { gecko_minversion_inline(“ 12.0 “)} }</li>
</ul>
<blockquote>
<p>XMLHttpRequest.upload 只读</p>
</blockquote>
<ul>
<li>XMLHttpRequestUpload，表示上传过程。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.withCredentials</p>
</blockquote>
<ul>
<li>Boolean，用来指定跨域的请求是否应该使用证书（如cookie或授权header头）。</li>
</ul>
<p>以下为非标准</p>
<blockquote>
<p>XMLHttpRequest.channel只读</p>
</blockquote>
<ul>
<li>nsIChannel，对象在执行请求时使用的通道。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.mozAnon只读</p>
</blockquote>
<ul>
<li>一个布尔值，如果为真，请求将在没有cookie和身份验证header头的情况下发送。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.mozSystem只读</p>
</blockquote>
<ul>
<li>一个布尔值，如果为真，则在请求时不会强制执行同源策略。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.mozBackgroundRequest</p>
</blockquote>
<ul>
<li>一个布尔值，它指示对象是否是后台服务器端的请求</li>
</ul>
<blockquote>
<p>XMLHttpRequest.mozResponseArrayBuffer 已废弃 Gecko 6 只读</p>
</blockquote>
<ul>
<li>一个ArrayBuffer类型，把请求的响应作为一个TypedArrays。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.multipart已废弃 Gecko 22</p>
</blockquote>
<ul>
<li>这个Gecko的独有属性，是一个布尔值，在Firefox/Gecko 22中被删除了。请使用Server-Sent Events, Web Sockets, 或来自进度事件的responseText代替</li>
</ul>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><blockquote>
<p>XMLHttpRequest.abort()</p>
</blockquote>
<ul>
<li>如果请求已经被发送,则立刻中止请求.</li>
</ul>
<blockquote>
<p>XMLHttpRequest.getAllResponseHeaders()</p>
</blockquote>
<ul>
<li>以字符串的形式返回所有用CRLF分隔的响应头，如果没有收到响应，则返回null。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.getResponseHeader()</p>
</blockquote>
<ul>
<li>返回包含指定响应头的字符串，如果响应尚未收到或响应中不存在该报头，则返回null。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.open()</p>
</blockquote>
<ul>
<li>初始化一个请求。该方法只能JavaScript代码中使用，若要在native code中初始化请求，请使用openRequest()。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.overrideMimeType()</p>
</blockquote>
<ul>
<li>重写由服务器返回的MIME type。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.send()</p>
</blockquote>
<ul>
<li>发送请求。如果请求是异步的（默认），那么该方法将在请求发送后立即返回。</li>
</ul>
<blockquote>
<p>XMLHttpRequest.setRequestHeader()</p>
</blockquote>
<ul>
<li>设置HTTP请求头的值。您必须在open()之后、send()之前调用setRequestHeader()这个方法。</li>
</ul>
<h4 id="说完属性和方法，到底怎么封装？"><a href="#说完属性和方法，到底怎么封装？" class="headerlink" title="说完属性和方法，到底怎么封装？"></a>说完属性和方法，到底怎么封装？</h4><p>一般情况下，我们都会面向对象的方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ajax = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> XMLHttpRequest !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> ActiveXObject !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">arguments</span>.callee.activeXString !== <span class="string">'string'</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> versions = [<span class="string">'MSXML2.XMLHttp.6.0'</span>, <span class="string">'MSXML2.XMLHttp.3.0'</span>, <span class="string">'MSXML2.XMLHttp'</span>];</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>,len = versions.length;i &lt; len;i++) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">var</span> xhr = <span class="keyword">new</span> ActiveXOject(versions[i]);</span><br><span class="line">                  <span class="built_in">arguments</span>.callee.activeXString = versions[i];</span><br><span class="line">                  <span class="keyword">return</span> xhr;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="built_in">arguments</span>.callee.activeXString);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"no xhr object available"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure>
<p>上面代码其实就是获取一个大当前浏览器支持的XHR对象，如果是现代浏览器那直接使用XMLHttpRequest对象，否则就是IE系列</p>
<p>接着就是基于XHR对象封装对应方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> AJAX = <span class="function"><span class="keyword">function</span>(<span class="params">ops</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> root = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> req = ajax; <span class="comment">//上面生成的ajax对象</span></span><br><span class="line">  root.url = ops.url;</span><br><span class="line">  root.type = ops.type || <span class="string">'responseText'</span>;</span><br><span class="line">  root.contentType = ops.contentType || <span class="string">'application/x-www-form-urlencoded'</span>;</span><br><span class="line">  root.method = ops.method || <span class="string">'GET'</span>;</span><br><span class="line">  root.async = ops.async || <span class="literal">true</span>;</span><br><span class="line">  root.data = ops.data || &#123;&#125;;</span><br><span class="line">  root.complete = ops.complete || <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">  root.success = ops.success || <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line">  root.error =  ops.error || <span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123; alert(root.url+<span class="string">'-&gt;status:'</span>+s+<span class="string">'error!'</span>)&#125;;</span><br><span class="line">  root.abort = req.abort;</span><br><span class="line">  root.timeout = ops.timeout;</span><br><span class="line">  root.setData = <span class="function"><span class="keyword">function</span>  (<span class="params">data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> d <span class="keyword">in</span> data) &#123;</span><br><span class="line">          root.data[d] = data[d];</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  root.send = <span class="function"><span class="keyword">function</span>  (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> datastring = root.contentType === <span class="string">'application/x-www-form-urlencoded'</span>? formatData(root.data) : root.data,</span><br><span class="line">      sendstring,get = <span class="literal">false</span>,</span><br><span class="line">      <span class="keyword">async</span> = root.async,</span><br><span class="line">      complete = root.complete,</span><br><span class="line">      method = root.method,</span><br><span class="line">      type = root.type,</span><br><span class="line">      contentType = root.contentType;</span><br><span class="line">      <span class="keyword">if</span>(method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">          root.url += <span class="string">'?'</span>+datastring;</span><br><span class="line">          get = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      req.open(method, root.url, <span class="keyword">async</span>);</span><br><span class="line">      <span class="keyword">if</span>(!get) &#123;</span><br><span class="line">          req.setRequestHeader(<span class="string">"Content-type"</span>,contentType);</span><br><span class="line">          sendstring = datastring;</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="comment">//在send之前重置onreadystatechange方法,否则会出现新的同步请求会执行两次成功回调(chrome等在同步请求时也会执行onreadystatechange)</span></span><br><span class="line">      req.onreadystatechange = <span class="keyword">async</span> ? <span class="function"><span class="keyword">function</span>  (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (req.readyState == <span class="number">4</span>)&#123;</span><br><span class="line">            complete();</span><br><span class="line">            <span class="keyword">if</span>(req.status == <span class="number">200</span>) &#123;</span><br><span class="line">                root.success(req[type]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                root.error(req.status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; : <span class="literal">null</span>;</span><br><span class="line">      req.send(sendstring);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">async</span>) &#123;</span><br><span class="line">          complete();</span><br><span class="line">          root.success(req[type]);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  root.url &amp;&amp; root.send();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最后来一手正儿八经的封装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="function"><span class="keyword">function</span> (<span class="params">name, root, factory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = factory(root);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123; <span class="comment">//require AMD</span></span><br><span class="line">    define(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">'object'</span>) &#123; <span class="comment">//common CMD</span></span><br><span class="line">    <span class="built_in">module</span>.exports = <span class="built_in">module</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    root[name] = <span class="built_in">module</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">window</span>[name] = <span class="built_in">module</span></span><br><span class="line">&#125;)(<span class="string">'_ajax'</span>, <span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ajax = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> XMLHttpRequest !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> ActiveXObject !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">arguments</span>.callee.activeXString !== <span class="string">'string'</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> versions = [<span class="string">'MSXML2.XMLHttp.6.0'</span>, <span class="string">'MSXML2.XMLHttp.3.0'</span>, <span class="string">'MSXML2.XMLHttp'</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>,len = versions.length;i &lt; len;i++) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">var</span> xhr = <span class="keyword">new</span> ActiveXOject(versions[i]);</span><br><span class="line">                        <span class="built_in">arguments</span>.callee.activeXString = versions[i];</span><br><span class="line">                        <span class="keyword">return</span> xhr;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="built_in">arguments</span>.callee.activeXString);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"no xhr object available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;());</span><br><span class="line">    <span class="keyword">var</span> formatData = <span class="function"><span class="keyword">function</span>(<span class="params">fd</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> res = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">in</span> fd) &#123;</span><br><span class="line">            res += f+<span class="string">'='</span>+fd[f]+<span class="string">'&amp;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res.slice(<span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> AJAX = <span class="function"><span class="keyword">function</span>(<span class="params">ops</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> root = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">var</span> req = ajax;</span><br><span class="line">        root.url = ops.url;</span><br><span class="line">        root.type = ops.type || <span class="string">'responseText'</span>;</span><br><span class="line">        root.contentType = ops.contentType || <span class="string">'application/x-www-form-urlencoded'</span>;</span><br><span class="line">        root.method = ops.method || <span class="string">'GET'</span>;</span><br><span class="line">        root.async = ops.async || <span class="literal">true</span>;</span><br><span class="line">        root.data = ops.data || &#123;&#125;;</span><br><span class="line">        root.complete = ops.complete || <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">        root.success = ops.success || <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line">        root.error =  ops.error || <span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123; alert(root.url+<span class="string">'-&gt;status:'</span>+s+<span class="string">'error!'</span>)&#125;;</span><br><span class="line">        root.abort = req.abort;</span><br><span class="line">        root.timeout = ops.timeout;</span><br><span class="line">        root.setData = <span class="function"><span class="keyword">function</span>  (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> d <span class="keyword">in</span> data) &#123;</span><br><span class="line">                root.data[d] = data[d];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        root.send = <span class="function"><span class="keyword">function</span>  (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> datastring = root.contentType===<span class="string">'application/x-www-form-urlencoded'</span>? formatData(root.data) : root.data,</span><br><span class="line">            sendstring,get = <span class="literal">false</span>,</span><br><span class="line">            <span class="keyword">async</span> = root.async,</span><br><span class="line">            complete = root.complete,</span><br><span class="line">            method = root.method,</span><br><span class="line">            type = root.type,</span><br><span class="line">            contentType = root.contentType;</span><br><span class="line">            <span class="keyword">if</span>(method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">                root.url += <span class="string">'?'</span>+datastring;</span><br><span class="line">                get = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            req.open(method, root.url, <span class="keyword">async</span>);</span><br><span class="line">            <span class="keyword">if</span>(!get) &#123;</span><br><span class="line">                req.setRequestHeader(<span class="string">"Content-type"</span>,contentType);</span><br><span class="line">                sendstring = datastring;</span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//在send之前重置onreadystatechange方法,否则会出现新的同步请求会执行两次成功回调(chrome等在同步请求时也会执行onreadystatechange)</span></span><br><span class="line">            req.onreadystatechange = <span class="keyword">async</span> ? <span class="function"><span class="keyword">function</span>  (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// console.log('async true');</span></span><br><span class="line">                <span class="keyword">if</span> (req.readyState ==<span class="number">4</span>)&#123;</span><br><span class="line">                    complete();</span><br><span class="line">                    <span class="keyword">if</span>(req.status == <span class="number">200</span>) &#123;</span><br><span class="line">                        root.success(req[type]);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        root.error(req.status);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; : <span class="literal">null</span>;</span><br><span class="line">            req.send(sendstring);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">async</span>) &#123;</span><br><span class="line">                <span class="comment">//console.log('async false');</span></span><br><span class="line">                complete();</span><br><span class="line">                root.success(req[type]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        root.url &amp;&amp; root.send();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">ops</span>) </span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> AJAX(ops);&#125;</span><br><span class="line">  &#125;();</span><br><span class="line">  <span class="keyword">return</span> xhr</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/28/webpack-plugins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/28/webpack-plugins/" itemprop="url">webpack_plugins</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-28T15:15:19+08:00">
                2018-09-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="webpack插件"><a href="#webpack插件" class="headerlink" title="webpack插件"></a>webpack插件</h3><h4 id="一个简单的-plugin"><a href="#一个简单的-plugin" class="headerlink" title="一个简单的 plugin"></a>一个简单的 <code>plugin</code></h4><p><code>plugin</code> 的实现可以是一个类，使用时传入相关配置来创建一个实例，然后放到配置的 <code>plugins</code> 字段中，而 <code>plugin</code> 实例中最重要的方法是 <code>apply</code>，该方法在 <code>webpack</code> <code>compiler</code> <code>安装插件时会被调用一次，apply</code> 接收 <code>webpack</code> <code>compiler</code> 对象实例的引用，你可以在 <code>compiler</code> 对象实例上注册各种事件钩子函数，来影响 <code>webpack</code> 的所有构建流程，以便完成更多其他的构建任务。</p>
<p>下边的这个例子，是一个可以创建 <code>webpack</code> 构建文件列表 markdown 的 <code>plugin</code>，实现上相对简单，但呈现了一个 <code>webpack</code> <code>plugin</code> 的基本形态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileListPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="comment">// 在 compiler 的 emit hook 中注册一个方法，当 webpack 执行到该阶段时会调用这个方法</span></span><br><span class="line">    compiler.hooks.emit.tap(<span class="string">'FileListPlugin'</span>, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 给生成的 markdown 文件创建一个简单标题</span></span><br><span class="line">      <span class="keyword">var</span> filelist = <span class="string">'In this build:\n\n'</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 遍历所有编译后的资源，每一个文件添加一行说明</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> filename <span class="keyword">in</span> compilation.assets) &#123;</span><br><span class="line">        filelist += (<span class="string">'- '</span>+ filename +<span class="string">'\n'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将列表作为一个新的文件资源插入到 webpack 构建结果中</span></span><br><span class="line">      compilation.assets[<span class="string">'filelist.md'</span>] = &#123;</span><br><span class="line">        source: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> filelist</span><br><span class="line">        &#125;,</span><br><span class="line">        size: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> filelist.length</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = FileListPlugin</span><br></pre></td></tr></table></figure>
<p>webpack 4.0 版本之前使用的是旧版本的 tapable，和新版本插件API有不少区别，基本注册事件一致，只是注册改变了。</p>
<h4 id="开发和调试-plugin"><a href="#开发和调试-plugin" class="headerlink" title="开发和调试 plugin"></a>开发和调试 <code>plugin</code></h4><p>你要在本地开发和调试 webpack plugin 是很容易的一件事情，你只需要创建一个 js 代码文件，如同上述的例子一样，该文件对外暴露一个类，然后在 webpack 配置文件中引用这个文件的代码，照样运行 webpack 构建查看结果即可。大概的配置方式如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设我们上述那个例子的代码是 ./plugins/FileListPlugin 这个文件</span></span><br><span class="line"><span class="keyword">const</span> FileListPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/FileListPlugin.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> FileListPlugin(), <span class="comment">// 实例化这个插件，有的时候需要传入对应的配置</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-中的事件钩子"><a href="#webpack-中的事件钩子" class="headerlink" title="webpack 中的事件钩子"></a>webpack 中的事件钩子</h4><p>重点关注的是webpack插件钩子，下面重点说下</p>
<p>先来一波文档充充饥 <a href="https://webpack.docschina.org/api/compiler/#%E4%BA%8B%E4%BB%B6%E9%92%A9%E5%AD%90" target="_blank" rel="noopener">compiler事件钩子</a>和<a href="https://webpack.docschina.org/api/compilation/" target="_blank" rel="noopener">compilation事件钩子</a></p>
<p>我们可以看到在事件钩子列表中看到，webpack 中会有相当多的事件钩子，基本覆盖了 webpack 构建流程中的每一个步骤，你可以在这些步骤都注册自己的处理函数，来添加额外的功能，这就是 webpack 提供的 plugin 扩展</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.hooks = &#123;</span><br><span class="line">  <span class="comment">// 这里的声明的事件钩子函数接收的参数是 compilation，</span></span><br><span class="line">  shouldEmit: <span class="keyword">new</span> SyncBailHook([<span class="string">"compilation"</span>]),</span><br><span class="line">  <span class="comment">// 这里接收的参数是 stats，以此类推</span></span><br><span class="line">  done: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"stats"</span>]),</span><br><span class="line">  additionalPass: <span class="keyword">new</span> AsyncSeriesHook([]),</span><br><span class="line">  beforeRun: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line">  run: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line">  emit: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line">  afterEmit: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line">  thisCompilation: <span class="keyword">new</span> SyncHook([<span class="string">"compilation"</span>, <span class="string">"params"</span>]),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面是webpack事件钩子申明的方式，可以看到有很多类型的事件钩子，从这里你可以看到各个事件钩子函数接收的参数是什么，你还会发现事件钩子会有不同的类型，例如 SyncBailHook，AsyncSeriesHook，SyncHook，接下来我们再介绍一下事件钩子的类型以及我们可以如何更好地利用各种事件钩子的类型来开发我们需要的 plugin。</p>
<h4 id="了解事件钩子类型"><a href="#了解事件钩子类型" class="headerlink" title="了解事件钩子类型"></a>了解事件钩子类型</h4><p>上述提到的 webpack compiler 中使用了多种类型的事件钩子，根据其名称就可以区分出是同步还是异步的，对于同步的事件钩子来说，注册事件的方法只有 tap 可用，例如上述的 shouldEmit 应该这样来注册事件函数的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apply(compiler) &#123;</span><br><span class="line">  compiler.hooks.shouldEmit.tap(<span class="string">'PluginName'</span>, (compilation) =&gt; &#123; <span class="comment">/* ... */</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但如果是异步的事件钩子，那么可以使用 tapPromise 或者 tapAsync 来注册事件函数，tapPromise 要求方法返回 Promise 以便处理异步，而 tapAsync 则是需要用 callback 来返回结果，例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">compiler.hooks.done.tapPromise(<span class="string">'PluginName'</span>, (stats) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 返回 promise</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这个例子是写一个记录 stats 的文件</span></span><br><span class="line">    fs.writeFile(<span class="string">'path/to/file'</span>, stats.toJson(), (err) =&gt; err ? reject(err) : resolve())</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">compiler.hooks.done.tapAsync(<span class="string">'PluginName'</span>, (stats, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 使用 callback 来返回结果</span></span><br><span class="line">  fs.writeFile(<span class="string">'path/to/file'</span>, stats.toJson(), (err) =&gt; callback(err))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果插件处理中没有异步操作要求的话，也可以用同步的方式</span></span><br><span class="line">compiler.hooks.done.tap(<span class="string">'PluginName'</span>, (stats, callback) =&gt; &#123;</span><br><span class="line">  callback(fs.writeFileSync(<span class="string">'path/to/file'</span>, stats.toJson())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>然而 <a href="https://github.com/webpack/tapable" target="_blank" rel="noopener">tapable</a> 这个工具库提供的钩子类型远不止这几种，多样化的钩子类型，主要是为了能够覆盖多种使用场景：</p>
<ol>
<li><p>连续地执行注册的事件函数</p>
</li>
<li><p>并行地执行注册的事件函数</p>
</li>
<li><p>一个接一个地执行注册的事件函数，从前边的事件函数获取输入，即瀑布流的方式<br>异步地执行注册的事件函数</p>
</li>
<li><p>在允许时停止执行注册的事件函数，一旦一个方法返回了一个非 undefined 的值，<br>就跳出执行流</p>
</li>
</ol>
<p>除了同步和异步的区别，我们再参考上述这一些使用场景，以及官方文档的 <a href="https://webpack.docschina.org/api/plugins/#tapable-%E5%92%8C-tapable-%E5%AE%9E%E4%BE%8B" target="_blank" rel="noopener">Plugin API</a>，进一步将事件钩子类型做一个区分。</p>
<p>名称带有 <code>parallel</code> 的，注册的事件函数会并行调用，如：</p>
<blockquote>
<p><code>AsyncParallelHook</code>、<code>AsyncParallelBailHook</code></p>
</blockquote>
<p>名称带有 <code>bail</code> 的，注册的事件函数会被顺序调用，直至一个处理方法有返回值（ParallelBail 的事件函数则会并行调用，第一个返回值会被使用）：</p>
<blockquote>
<p><code>SyncBailHook</code>、<code>AsyncParallelBailHook</code>、<code>AsyncSeriesBailHook</code></p>
</blockquote>
<p>名称带有 <code>waterfall</code> 的，每个注册的事件函数，会将上一个方法的返回结果作为输入参数，如：</p>
<blockquote>
<p><code>SyncWaterfallHook</code>、<code>AsyncSeriesWaterfallHook</code></p>
</blockquote>
<p>通过上面的名称可以看出，有一些类型是可以结合到一起的，如 AsyncParallelBailHook，这样它就具备了更加多样化的特性。</p>
<p>了解了 webpack 中使用的各个事件钩子的类型，才能在开发 plugin 更好地去把握注册事件的输入和输出，同步和异步，来更好地完成我们想要的构建需求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugin 的实现可以是一个类， 使用时传入相关配置来创建一个实例， 然后放到配置的 plugins 字段中， 而 plugin 实例中最重要的方法是 apply， </span></span><br><span class="line"><span class="comment">// 该方法在 webpack compiler 安装插件时会被调用一次，apply 接收 webpack compiler 对象实例的引用，</span></span><br><span class="line"><span class="comment">// 你可以在 compiler 对象实例上注册各种事件钩子函数，来影响 webpack 的所有构建流程， 以便完成更多其他的构建任务。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="keyword">const</span> SyncHook = <span class="built_in">require</span>(<span class="string">'tapable'</span>).SyncHook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pluginName = <span class="string">'FileListPlugin'</span></span><br><span class="line"><span class="keyword">const</span> Log = <span class="function">(<span class="params">str, obj</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(chalk.blue(<span class="string">'\n'</span>+str));<span class="built_in">console</span>.log(obj, +<span class="string">'\n'</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileListPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (compiler.hooks.myCustomHook) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Already in use'</span>);</span><br><span class="line">    compiler.hooks.myCustomHook = <span class="keyword">new</span> SyncHook([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 compiler 的 emit hook 中注册一个方法，当 webpack 执行到该阶段时会调用这个方法</span></span><br><span class="line">    compiler.hooks.emit.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'emit'</span>)</span><br><span class="line">      compiler.hooks.myCustomHook.call(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">let</span> chunkslist = <span class="string">'In this build chunks:\n\n'</span></span><br><span class="line">      <span class="keyword">let</span> chunks = compilation.chunks</span><br><span class="line">      <span class="comment">// console.log('chunks', chunks)</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> chunkid <span class="keyword">of</span> chunks) &#123;</span><br><span class="line">        <span class="comment">// Log('chunkid', chunkid)</span></span><br><span class="line">        chunkslist += (<span class="string">'- '</span> + chunkid + <span class="string">'\n'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将 chunks 信息写下来</span></span><br><span class="line">      compilation.assets[<span class="string">'chunkslist.md'</span>] = &#123;</span><br><span class="line">        source: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> chunkslist</span><br><span class="line">        &#125;,</span><br><span class="line">        size: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> chunkslist.length</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> filelist = <span class="string">'In this build:\n\n'</span></span><br><span class="line">      <span class="comment">// 遍历所有编译后的资源，每一个文件添加一行说明</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> filename <span class="keyword">in</span> compilation.assets) &#123;</span><br><span class="line">        filelist += (<span class="string">'- '</span> + filename + <span class="string">'\n'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将列表作为一个新的文件资源插入到 webpack 构建结果中</span></span><br><span class="line">      compilation.assets[<span class="string">'filelist.md'</span>] = &#123;</span><br><span class="line">        source: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> filelist</span><br><span class="line">        &#125;,</span><br><span class="line">        size: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> filelist.length</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    compiler.hooks.compile.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'compile'</span>, compilation.chunks)</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks.compilation.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="comment">// Log('compilation', compilation.chunks)</span></span><br><span class="line">      compilation.hooks.optimize.tap(pluginName, (coms) =&gt; &#123;</span><br><span class="line">        Log(<span class="string">'compilation.hooks'</span>, coms)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks.done.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'done'</span>, compilation.chunks)</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks.failed.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'failed'</span>, compilation.chunks)</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks.afterEmit.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'afterEmit'</span>, compilation.chunks.length)</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks.run.tapAsync(pluginName, (compilation,callback) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'run'</span>, compilation.chunks)</span><br><span class="line">      callback()</span><br><span class="line">    &#125;)</span><br><span class="line">    compiler.hooks[<span class="string">'watchRun'</span>].tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      Log(<span class="string">'watchRun'</span>, compilation.chunks)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = FileListPlugin</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/bucky-core原理及实现细节/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/16/bucky-core原理及实现细节/" itemprop="url">bucky-core原理及实现细节</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-16T10:15:27+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="bucky基本原理"><a href="#bucky基本原理" class="headerlink" title="bucky基本原理"></a>bucky基本原理</h3><h4 id="挂载hooks文件"><a href="#挂载hooks文件" class="headerlink" title="挂载hooks文件"></a>挂载<code>hooks</code>文件</h4><blockquote>
<p>包含<code>error, config, bodyparser, formparser, rewrite, log, csrf, cors, response, view, static, context, mysql, redis, api, model, service, action, socket, lift</code>，二十个模块定义APP错误日志，监听启动错误日志</p>
</blockquote>
<h4 id="config配置"><a href="#config配置" class="headerlink" title="config配置"></a><code>config</code>配置</h4><blockquote>
<p><code>config</code>业务配置，模块会传入APP实例，app参数配置，但这个时候 <code>app.config</code> 上只有<code>appPath</code>，获取用户<code>config</code>配置路径，挂载 <code>package.json</code> 信息<br><code>ignoreConfigFiles</code>是否忽略配置，挂在<code>lodash</code>，并将<code>_</code>.js挂入忽略配置数组<br>尝试获取<code>env.js</code>下的配置，包含当前node环境</p>
</blockquote>
<blockquote>
<p>抓取<code>configs/*.js</code>文件，排除忽略的配置，获取对应文件的文件路径，必须先加载<code>app.js</code>，<code>loadConfig</code>做深度merge当前环境，再delete app路径防止重复加载，<code>proxy</code>设置，然后加载其他config文件，加载文件的时候有错则放入<code>app.initErrors</code>里。</p>
</blockquote>
<blockquote>
<p>如果存在socket文件且开启socket，启动http服务</p>
</blockquote>
<blockquote>
<p>中间件：代理请求头，重置或重写代理请求头</p>
</blockquote>
<blockquote>
<p>中间件：设置请求头<code>uuid</code>和<code>sequence</code></p>
</blockquote>
<h4 id="bodyparser配置"><a href="#bodyparser配置" class="headerlink" title="bodyparser配置"></a><code>bodyparser</code>配置</h4><blockquote>
<p>获取在<code>config</code>加载阶段挂载到<code>app.config</code>上的<code>bodyparser</code><br>主要是设置解析请求body的参数，比如上传文件大小限制等等</p>
</blockquote>
<blockquote>
<p>中间件：<code>bodyparser</code></p>
</blockquote>
<h4 id="formparser配置"><a href="#formparser配置" class="headerlink" title="formparser配置"></a><code>formparser</code>配置</h4><blockquote>
<p>获取在config加载阶段挂载到<code>app.config</code>上的<code>formparser</code></p>
</blockquote>
<blockquote>
<p>中间件：处理表单文件内容和文件内容，将表单数据挂载到ctx</p>
</blockquote>
<h4 id="rewrite配置"><a href="#rewrite配置" class="headerlink" title="rewrite配置"></a><code>rewrite</code>配置</h4><blockquote>
<p>获取在config加载阶段挂载到<code>app.config</code>上的<code>rewrite</code></p>
</blockquote>
<blockquote>
<p>中间件：处理用户自定义<code>rewrite</code>规则，这里会用到两个处理规则函数，<code>match</code>和<code>makeTo</code>，<code>match</code>处理匹配命中规则，<code>from</code>规则支持正则、函数、字符串，正则也就是整儿白净的正则，函数的话，会给函数传入请求头部信息，返回非<code>null</code>则认为是匹配成功，并返回匹配数组。字符串则使用<code>minimatch</code>规则，<code>minimatch</code>这里面可能有个坑，比如你想转一个路由，比如<code>a/b=&gt;a/b/</code>这种，那么<code>minimatch</code>会认为这两个是一样的<code>minimatch(&quot;a/b/&quot;, &quot;a/b&quot;)</code> // true!，<code>makeTo</code>处理跳转规则，<code>to</code>规则支持函数和字符串，函数则自行处理，字符串则替换字符串中的<code>${index}</code>为<code>match</code>规则中的数据，返回处理后数据，然后解析该<code>url</code>，合并<code>request</code>的<code>query</code>和替换<code>path</code>，也就是说路径可自定义，<code>query</code>参数为merge方式<br>获取在<code>config</code>加载阶段挂载到<code>app.config</code>上的<code>redirect</code></p>
</blockquote>
<blockquote>
<p>中间件：处理用户自定义<code>redirect</code>规则，处理匹配规则经过<code>matchFrom</code>和<code>makeTo</code>处理，然后构造目标<code>url</code>，最后重定向这个目标<code>url</code></p>
</blockquote>
<h4 id="log配置"><a href="#log配置" class="headerlink" title="log配置"></a><code>log</code>配置</h4><blockquote>
<p>写日志采用第三方库，<code>log4js</code></p>
</blockquote>
<p>中间件：触发<code>access</code>日志，并处理<code>input/output</code>两种情况<br>重写<code>console.log</code>和<code>console.error</code>，其中分别触发<code>application、error</code>日志</p>
<h4 id="csrf配置"><a href="#csrf配置" class="headerlink" title="csrf配置"></a><code>csrf</code>配置</h4><blockquote>
<p>跨站请求伪造，简单理解攻击者盗用了你的身份，以你的名义发送恶意请求<br>中间件：用来生成<code>csrf token</code></p>
</blockquote>
<h4 id="cors配置"><a href="#cors配置" class="headerlink" title="cors配置"></a><code>cors</code>配置</h4><p><code>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</code></p>
<blockquote>
<p>中间件：每次请求都会重新绑定<code>cors</code>检测函数到本次请求的上下文上也就是·，然后在<code>action</code>执行的时候回检测是否有<code>action</code>的<code>cors</code>设置参数，有则检验并设置<code>cors</code>响应头</p>
</blockquote>
<blockquote>
<p>设置<code>cors</code>参数支持函数、字符串、Bool类型，启用<code>cors</code>后设置响应头，<code>*</code>/用户自定义/<br>如果设置并非<code>*</code>，则头中必须设置<code>Vary</code>为<code>Origin</code>，目地告诉客户端服务端对不同源返回不同内容</p>
</blockquote>
<blockquote>
<p>设置<code>headers</code>，将请求中设置<code>headers</code>，作为相应头的<code>headers</code>传回，请求的<code>headers</code>会作为预检请求的<code>headers</code>，目前告诉服务器实际请求使用的<code>headers</code>，同理告诉客户端实际允许的<code>headers</code></p>
</blockquote>
<blockquote>
<p>设置<code>methods</code>，同理<code>headers</code></p>
</blockquote>
<blockquote>
<p>设置<code>expose-headers</code>，在跨域请求中，<code>xhr</code>对象中<code>getResponseHeader()</code>只能获取基本的响应头，<code>cache-control、content-language、content-type、expires、last-modified、pragma</code>，访问其他头需要服务端设置响应头<code>expose-headers</code>白名单</p>
</blockquote>
<blockquote>
<p>设置<code>max-age</code>，设置改参数表示<code>preflight</code>（预检）请求缓存多久有效</p>
</blockquote>
<blockquote>
<p>设置<code>credentials</code>，表示当前浏览器的是否被允许读取<code>response</code>的内容，如果是预检请求中，则表示实际请求是否可以使用<code>credentials</code></p>
</blockquote>
<h4 id="response配置"><a href="#response配置" class="headerlink" title="response配置"></a><code>response</code>配置</h4><blockquote>
<p>封装相应函数，<code>200、302、403、404、500</code>，同时支持自定义<code>response</code></p>
</blockquote>
<blockquote>
<p>中间件：挂载上述封装方法</p>
</blockquote>
<blockquote>
<p>中间件：挂载自定义方法到当前请求上下文，自定义<code>response</code>中，会传入事先挂载到<code>app.config</code>上的<code>response</code>配置</p>
</blockquote>
<h4 id="view配置"><a href="#view配置" class="headerlink" title="view配置"></a><code>view</code>配置</h4><blockquote>
<p>获取当前用户view配置，模板类型，编译调试参数等<br>获取<code>views</code>模板匹配路由表，目前也就是让<code>/</code>映射到<code>/views/</code>下<br>构造<code>render</code>函数，<code>renderTemplate</code>函数，函数参数当前<code>appPath</code>、待匹配路由表，当前模板配置<br>取出当前配置参数，类型、数据、母模板、本次<code>render</code>类型，支持<code>ejs/pug</code>两种，支持缓存（<code>内存</code>），内部实现先查看是否有使用及有无缓存，有则返回，注意这里挂载内存上的是编译后的模板函数，不包含数据<br>构造真正的带数据模板，函数参数为是否<code>string、view</code>路径，数据，<code>viewConfig</code>（目前仅使用<code>layout</code>参数），构造<code>view</code>路径，数据（merge 本次data到全局data），然后拿构造的<code>view</code>路径去待匹配的路由表中查<code>view</code>文件，然后构造<code>view</code>文件路径，然后拿着<code>view</code>文件路径和数据data使用事先构造的模板函数进行编译，这个时候编译后的只是文档片段(html)，尚未使用，这个时候查是否有<code>layout</code>母模板，有则再匹配和编译一次，本次编译使用的数据为之前的<code>data</code>和<code>{body:html}</code>，最后将这些数据绑定到本次的请求上下文对象上，比如 <code>Object.assign(this.response, { type: &#39;html&#39;, body: html })</code>，这样也就完成了渲染</p>
</blockquote>
<blockquote>
<p>中间件：将构造构造<code>render</code>函数绑定到<code>response</code>和本次请求上下文，两种方式字符串和文档</p>
</blockquote>
<h4 id="static配置"><a href="#static配置" class="headerlink" title="static配置"></a><code>static</code>配置</h4><blockquote>
<p>首先还是merge用户和默认配置，生成<code>source_buffer</code>，生成<code>Static</code>对象，该对象提供几种获取文件方式参数，获取文件的<code>md5</code>值、获取文件的<code>buffer</code>类型数据（这里有缓存机制，即cache配置）、获取文本、获取<code>base64</code>类型</p>
</blockquote>
<blockquote>
<p>构造<code>static</code>文件路由表，同时如果有<code>mix</code>配置则走<code>mix</code>文件，如果有<code>manifest</code>配置，则存到<code>Static.assets</code>，<code>assets</code>下存的是文件路径和<code>md5</code>后的映射关系，最后暴露<code>Static</code>到<code>global</code></p>
</blockquote>
<blockquote>
<p>中间件：在缓存和<code>manifest</code>同时开启情况下，存<code>static</code>文件的<code>origin=&gt;source</code>关系，然后根据传入文件路径，返回指定类型的文件数据，这里会处理<code>etag、lastModified</code>，且默认是<code>*</code>跨域，<code>cache-control</code>时间默认10s，<code>expires</code>默认当前服务器时间+10s，在<code>query</code>中含<code>nocache&amp;request</code>含<code>fresh</code>（缓存是否新鲜），走<code>304</code></p>
</blockquote>
<h4 id="context配置"><a href="#context配置" class="headerlink" title="context配置"></a><code>context</code>配置</h4><blockquote>
<p>中间件：据说是用来追踪请求用的。。。。</p>
</blockquote>
<h4 id="MySQL、Redis就不解释了，很简单"><a href="#MySQL、Redis就不解释了，很简单" class="headerlink" title="MySQL、Redis就不解释了，很简单"></a><code>MySQL、Redis</code>就不解释了，很简单</h4><h4 id="api配置"><a href="#api配置" class="headerlink" title="api配置"></a><code>api</code>配置</h4><blockquote>
<p>首先还是merge用户和默认配置，这里得说明下，之前<code>bucky</code>是没有暴露<code>config.api</code>配置给用户的，三部曲中的只有<code>action</code>有用户配置，而且一般也不会改动，除非你的<code>action</code>里有共有的部分<br>然后拿着merge后的<code>config</code>创建<code>API</code>，参数中可设置的有<code>queryEncode</code>、<code>contentType</code>、<code>userAgent</code>、<code>requestHandler</code>、<code>responseHandler</code>、<code>cache</code>、<code>host</code>、<code>proxy</code>等，这些参数也可以在某类<code>API</code>中设置。</p>
</blockquote>
<blockquote>
<p>这里首先会创建一个<code>API</code>类，该类为全局<code>API</code>对象，然后获取当前设置<code>api</code>根目录，其实也就是<code>apis/</code>，然后遍历<code>apis/</code>文件夹，拿到文件路径，然后解析（<code>requireAPI</code>）该<code>api</code>文件配置，里面包含解析文件的配置，配置包含默认环境配置、特殊环境配置，每一个环境中配置都是以函数形式，配置中<code>export</code>类型有三个环境，创建配置中会生成该<code>API</code>的<code>configMap</code>，存放<code>apiName</code>与<code>apiconfig</code>映射关系，然后执行该<code>API</code>文件中的注册<code>API</code>，然后生成<code>API</code>配置，然后深度merge两个环境的各自的基础配置和<code>configMap</code>（<code>APIName</code>与<code>APIConfig</code>映射关系），最后会merge每个<code>API</code>的<code>config</code>到<code>baseConfig</code>。然后会遍历这个总的<code>config</code>，里面包含这个<code>API</code>的所有配置，以及每个<code>api</code>的配置，生成<code>API.APIName.apiName</code>，这种格式，如<code>API.Test.test</code>，然后拿着这个和文件路径生成<code>API</code>（<code>createAPI</code>）<br><code>createAPI</code>里：首先解析每个<code>api</code>类的配置，这里的配置是某一个<code>api</code>配置和<code>API</code>基础配置的深度merge，最终返回的是一个api函数，也就是我们通常会调用的<code>API.Test.test(data,  options)</code>这种形式，函数里面干了什么事情呢，首先从<code>options</code>中解析四个参数，<code>query/headers/uriReplacer/ctx</code>，拿着前面解析的<code>parameters</code>做接口数据类型检查，然后创建<code>api</code>请求数据对象，包含<code>uri method timeout proxy displayname encoding headers</code>，<code>headers</code>中会使用每个<code>api</code>中的<code>contenttype</code>、<code>userAgent</code>、<code>host</code>然后merge传入的<code>headers</code>，所以<code>header</code>可以在<code>api</code>中设置。</p>
</blockquote>
<blockquote>
<p>根据方法名，合并参数，包含<code>GET、HEAD、OPTIONS</code>三个，剩下处理<code>body</code>数据，<code>multipart/form-data</code>文件类型的表单提交，然后将<code>formData</code>写到上述创建的<code>api</code>请求数据对象中，<code>formData</code>中包含<code>data</code>里面的数据，如果是流<code>stream</code>类型，则设置<code>filename</code>和<code>contentType</code>；</p>
</blockquote>
<blockquote>
<p><code>application/json</code>类型则直接设置body为<code>stringify(data)</code>后的数据；</p>
</blockquote>
<blockquote>
<p><code>application/x-www-form-urlencoded</code>类型则设置<code>form</code>为<code>data</code>，其余类型则直接<code>data</code>挂到<code>body</code>。然后拼装<code>uri</code>，通过<code>base、uriReplacer</code>规则，然后将<code>query</code>对象转为<code>search</code>类型，此时通过<code>queryEncode</code>判断是否转码。<br>调用<code>requestHandler</code>，参数有创建的请求数据对象、<code>ctx</code>，这个时候需要注意，如果你的<code>requestHandler</code>是自定义的，那么需要注意，函数中需要返回你处理后的请求数据对象，然后bucky拿着处理后的请求数据对象，然后处理<code>cache</code>缓存，这里默认使用的是<code>Redis</code>，如果使用缓存且缓存有效则使用缓存的结果作为返回，反之发起请求<code>doRequest</code></p>
</blockquote>
<blockquote>
<p><code>doRequest</code>中有递增请求<code>sequence</code>的操作，标识请求的唯一和连续，记录请求时间，请求使用<code>request</code>库，自己封装为<code>promise</code>方式，如果出错则抛出错误，并记录到<code>log.api</code>日志中，正常则调用<code>responseHandler</code>方法，同样报错则抛出错误，如果有<code>cache</code>设置则写到缓存，同时会直接返回这个<code>responseHandler</code>的处理结果<br>上述创建完成后，会将<code>api</code>和<code>apis</code>分别挂载到<code>apis</code>上和<code>API</code> 上，这里会重写<code>get</code>方法，避免被篡改</p>
</blockquote>
<p>特别注意：上述说到的<code>requestHandler</code>、<code>responseHandler</code>都提供有默认的，<code>defaultRequestHandler</code>简单的返回请求数据对象，<code>defaultResponseHandler</code>则会校验<code>statusCode</code>，解析<code>codeKey、dataKey、messageKey、successCode</code>，这里可以通过刚刚说到的<code>config</code>设置，然后会从返回的<code>body</code>中解析对应的字段，然后检查<code>successCode</code>，如果你的<code>body</code>中的<code>codeKey</code>对应的值和<code>successCode</code>不对应，则会抛出错误</p>
<h4 id="model配置"><a href="#model配置" class="headerlink" title="model配置"></a><code>model</code>配置</h4><p><code>model</code>配置也是老套路，先解析挂载在<code>app.config</code>上的<code>model</code>配置，获取<code>model</code>的路径，然后加载自己的<code>model</code>，<code>HdicAuth、Utils、S3、WebShot</code>，然后挂载业务<code>model</code></p>
<h4 id="service配置"><a href="#service配置" class="headerlink" title="service配置"></a><code>service</code>配置</h4><p><code>service</code>是用于拦截请求用的，粗糙点说就是在<code>action/model/api</code>之前会执行这个，这里可以拦截并处理这个请求，<code>service</code>采用中间件，首先加载内部的三个<code>service</code>，<code>appwebview、logviewer、login</code>，然后获取业务自定义的<code>service</code>，这里注意到有<code>service</code>各自的依赖<code>service</code></p>
<h4 id="登录service配置"><a href="#登录service配置" class="headerlink" title="登录service配置"></a>登录<code>service</code>配置</h4><p>目前service中包含三个service，login、appwebview、logviewer，三个模块中需要重点说明的是login模块，目前login模块中包含三种方式，分别为cas（uc最新提供的登录方式）、general（原UC登录方式）、hdic（楼盘字典登录），目前使用率最高的为general，部分用cas，hdic就一个，下面简单说明集成方式。</p>
<p>首先login/index.js中export一个函数，该函数管理（校验）三种登录方式。</p>
<p>接着看general方式，首先有部分基础配置<code>appWebViewLoginScript</code>、URL_BASE</p>
<h4 id="appwebview配置"><a href="#appwebview配置" class="headerlink" title="appwebview配置"></a><code>appwebview</code>配置</h4><h4 id="logviewer配置"><a href="#logviewer配置" class="headerlink" title="logviewer配置"></a><code>logviewer</code>配置</h4><p>未完待续</p>
<p><img src="https://note.youdao.com/yws/public/resource/b6294f3ba9422486ed7b102071ea432f/xmlnote/WEBRESOURCEc5e01eb699351d89913f614811a5e330/4979?ynotemdtimestamp=1535694981361" alt="avatar"></p>
<p>简单描述下：</p>
<blockquote>
<p>首先<code>bucky</code>作为中间层，处于业务<code>server</code>和<code>UI client</code>之间，同时作为应用服务器，里面模块主要包含上面罗列的模块</p>
</blockquote>
<blockquote>
<p>我们称<code>client</code>为 <code>UI client</code>，也就是通常说的传统意义的前端客户端，然后到<code>bucky</code>，首先到<code>redirect</code>，判断是否服务重定向规则，符合则重写浏览器<code>url</code>并发起请求，接着判断是否符合<code>rewrite</code>重写规则，重定向和重写区别，简单讲，比如你想去商店买个面包，但这个商店没面包，但老板说我帮去另外商店找一个给你，这叫重写；如果老师直接让你去哪个商店买面包，这叫重定向。好了，说回来，如果符合<code>rewrite</code>规则，这个时候，<code>bucky</code>会帮你重写浏览器<code>uri</code>，但不会重新发起请求，然后到<code>services</code>层，如果你没有自定义的<code>service</code>，那就是走默认的三个<code>service</code>，如果有自定义的<code>service</code>，则会在<code>action</code>之前执行，所以我们某些时候会用<code>service</code>来做请求的拦截或单独处理不走<code>action</code>及后续逻辑，然后<code>action</code>中可以调用<code>model、api、redis、mysql</code>这些，然后我们在<code>action</code>（action中可能有很复杂的业务或数据处理）中返回这个请求，也就是到了上面的<code>response</code>模块，最后到<code>UI client</code>。上面还有一个模块<code>websocket</code>，<code>websocket</code>是很灵活的，可以和<code>client</code>双向或单向通信，比如我们的<code>logviewer</code>其实就是一个<code>websocket</code>，当然<code>websocket</code>里也照样可以调用<code>api</code> <code>model</code> 等模块。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/27/rewrite与redirect区别/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/27/rewrite与redirect区别/" itemprop="url">rewrite与redirect区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-27T10:25:58+08:00">
                2018-07-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>谈及这两个概念，通常会想到这应该是后端考虑的事情，但现在前端coder也需要关注这个，因为现在有个大前端概念，node中有这个概念，需要我们关注。<br>我们搞node中间层，会涉及到重写url和重定向，所有也就有了这两个。</p>
<h3 id="rewrite和redirect的区别"><a href="#rewrite和redirect的区别" class="headerlink" title="rewrite和redirect的区别"></a>rewrite和redirect的区别</h3><h4 id="redirect，即重定向。"><a href="#redirect，即重定向。" class="headerlink" title="redirect，即重定向。"></a>redirect，即重定向。</h4><h4 id="rewrite，即重写，不仅仅可以实现redirect在url规则上的重定向，还可以直接重写请求到实际的文件以及更多附加功能。"><a href="#rewrite，即重写，不仅仅可以实现redirect在url规则上的重定向，还可以直接重写请求到实际的文件以及更多附加功能。" class="headerlink" title="rewrite，即重写，不仅仅可以实现redirect在url规则上的重定向，还可以直接重写请求到实际的文件以及更多附加功能。"></a>rewrite，即重写，不仅仅可以实现redirect在url规则上的重定向，还可以直接重写请求到实际的文件以及更多附加功能。</h4><h4 id="重定向和URL重写的具体区别："><a href="#重定向和URL重写的具体区别：" class="headerlink" title="重定向和URL重写的具体区别："></a>重定向和URL重写的具体区别：</h4><p>（1）关于重定向</p>
<p>通过重定向，浏览器知道页面位置发生变化，从而改变地址栏显示的地址。</p>
<p>通过重定向，搜索引擎意识到页面被移动了，从而更新搜索引擎索引，将原来失效的链接从搜索结果中移除。</p>
<p>临时重定向(R=302)和永久重定向(R=301)都是亲搜索引擎的，是SEO的重要技术。</p>
<p>redirect是浏览器和服务器发生两次请求，也就是服务器命令客户端“去访问某个页面”；</p>
<p>redirect的URL需要传送到客户端。</p>
<p>redirect是从一个地址跳转到另一个地址。</p>
<p>（2）关于重写</p>
<p>rewrite的URL只是在服务器端</p>
<p>rewrite则是服务器内部的一个接管，在服务器内部告诉“某个页面请帮我处理这个用户的请求”，浏览器和服务器只发生一次交互，浏览器不知道是该页面做的响应，浏览器只是向服务器发出一个请求。</p>
<p>URL重写用于将页面映射到本站另一页面，若重写到另一网络主机（域名），则按重定向处理。</p>
<p>rewrite是把一个地址重写成另一个地址。地址栏不跳转。相当于给另一个地址加了一个别名一样。</p>
<p>上述的例子就像用户去买手机，缺货时的两种处理：让用户自己去其他地方买（redirect）；公司从其他的地方调货（rewrite）。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/01/webpack构建工具-hpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/01/webpack构建工具-hpack/" itemprop="url">webpack构建工具-hpack</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-01T17:36:40+08:00">
                2018-07-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="webpack工具集成-babel-polyfill-runtime"><a href="#webpack工具集成-babel-polyfill-runtime" class="headerlink" title="webpack工具集成-babel polyfill runtime"></a>webpack工具集成-babel polyfill runtime</h1><h4 id="这里简单说下-转义BABEL的POLYFILL和RUNTIME的区别"><a href="#这里简单说下-转义BABEL的POLYFILL和RUNTIME的区别" class="headerlink" title="这里简单说下 转义BABEL的POLYFILL和RUNTIME的区别"></a>这里简单说下 <code>转义BABEL的POLYFILL和RUNTIME的区别</code></h4><p><code>babel-polyfill</code> 使用场景</p>
<p><code>Babel</code> 默认只转换新的 <code>JavaScript</code> 语法，而不转换新的 API。例如，<code>Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise</code> 等全局对象，以及一些定义在全局对象上的方法（比如 <code>Object.assign</code>）都不会转译。如果想使用这些新的对象和方法，必须使用 <code>babel-polyfill</code>，为当前环境提供一个垫片。</p>
<p><code>babel-runtime</code> 使用场景</p>
<p>Babel 转译后的代码要实现源代码同样的功能需要借助一些帮助函数，例如，<code>{ [name]: &#39;JavaScript&#39; }</code> 转译后的代码如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_defineProperty</span>(<span class="params">obj, key, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">      value: value,</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      configurable: <span class="literal">true</span>,</span><br><span class="line">      writable: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    obj[key] = value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = _defineProperty(&#123;&#125;, <span class="string">'name'</span>, <span class="string">'JavaScript'</span>);</span><br></pre></td></tr></table></figure>
<p>类似上面的帮助函数 <code>_defineProperty</code> 可能会重复出现在一些模块里，导致编译后的代码体积变大。Babel 为了解决这个问题，提供了单独的包 babel-runtime 供编译模块复用工具函数。</p>
<p>启用插件 <code>babel-plugin-transform-runtime</code> 后，<code>Babel</code> 就会使用 <code>babel-runtime</code> 下的工具函数，转译代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="comment">// 之前的 `_defineProperty` 函数已经作为公共模块 `babel-runtime/helpers/defineProperty` 使用</span></span><br><span class="line"><span class="keyword">var</span> _defineProperty2 = <span class="built_in">require</span>(<span class="string">'babel-runtime/helpers/defineProperty'</span>);</span><br><span class="line"><span class="keyword">var</span> _defineProperty3 = _interopRequireDefault(_defineProperty2);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line"><span class="keyword">var</span> obj = (<span class="number">0</span>, _defineProperty3.default)(&#123;&#125;, <span class="string">'name'</span>, <span class="string">'JavaScript'</span>);</span><br></pre></td></tr></table></figure>
<p>除此之外，<code>babel</code> 还为源代码的非实例方法（<code>Object.assign</code>，实例方法是类似这样的 <code>&quot;foobar&quot;.includes(&quot;foo&quot;)</code>）和 <code>babel-runtime/helps</code> 下的工具函数自动引用了 <code>polyfill</code>。这样可以避免污染全局命名空间，非常适合于 JavaScript 库和工具包的实现。例如 <code>const obj = {}, Object.assign(obj, { age: 30 });</code> 转译后的代码如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="comment">// 使用了 core-js 提供的 assign</span></span><br><span class="line"><span class="keyword">var</span> _assign = <span class="built_in">require</span>(<span class="string">'babel-runtime/core-js/object/assign'</span>);</span><br><span class="line"><span class="keyword">var</span> _assign2 = _interopRequireDefault(_assign);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line">(<span class="number">0</span>, _assign2.default)(obj, &#123;</span><br><span class="line">  age: <span class="number">30</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>思考：<code>babel-runtime</code> 为什么适合 <code>JavaScript</code> 库和工具包的实现？</p>
<p>避免 babel 编译的工具函数在每个模块里重复出现，减小库和工具包的体积；</p>
<p>在没有使用 <code>babel-runtime</code> 之前，库和工具包一般不会直接引入 <code>polyfill</code>。否则像 <code>Promise</code> 这样的全局对象会污染全局命名空间，这就要求库的使用者自己提供 <code>polyfill</code>。这些 <code>polyfill</code> 一般在库和工具的使用说明中会提到，比如很多库都会有要求提供 es5 的 <code>polyfill</code>。在使用 <code>babel-runtime</code> 后，库和工具只要在 <code>package.json</code> 中增加依赖 <code>babel-runtime</code>，交给 <code>babel-runtime</code> 去引入 <code>polyfill</code> 就行了；</p>
<p>总结：</p>
<p>具体项目还是需要使用 <code>babel-polyfill</code>，只使用babel的话，实例方法不能正常工作（例如 “foobar”.includes(“foo”)）；</p>
<p><code>JavaScript</code> 库和工具可以使用 <code>babel-runtime</code>，在实际项目中使用这些库和工具，需要该项目本身提供 <code>polyfill</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/函数消抖与节流/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/24/函数消抖与节流/" itemprop="url">函数消抖与节流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-24T08:43:55+08:00">
                2018-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="函数防抖与节流是很相似的概念，但它们的应用场景不太一样。"><a href="#函数防抖与节流是很相似的概念，但它们的应用场景不太一样。" class="headerlink" title="函数防抖与节流是很相似的概念，但它们的应用场景不太一样。"></a>函数防抖与节流是很相似的概念，但它们的应用场景不太一样。</h3><p>我们先从概念上深刻理解它们。</p>
<h4 id="消抖"><a href="#消抖" class="headerlink" title="消抖"></a>消抖</h4><p>先说函数<code>防抖</code>-<code>debounce</code>。其概念其实是从机械开关和继电器的“去弹跳”（debounce）衍生 出来的，基本思路就是把多个信号合并为一个信号。</p>
<p>单反也有相似的概念，在拍照的时候手如果拿不稳晃的时候拍照一般手机是拍不出好照片的，因此智能手机是在你按一下时连续拍许多张，通过合成手段，生成一张。翻译成JS就是，事件内的N个动作会被忽略，只有事件后由程序触发的动作有效。</p>
<p>实现思路如下，将目标方法（动作）包装在setTimeout里面，然后这个方法是一个事件的回调函数，如果这个回调一直执行，那么这些动作就一直不执行。为什么不执行呢，我们搞了一个clearTimeout，这样setTimeout里的方法就不会执行！ 为什么要clearTimeout呢，我们就需要将事件内的连续动作删掉嘛！待到用户不触发这事件了。那么setTimeout就自然会执行这个方法。</p>
<p>那么这个方法用在什么地方呢，就是用于input输入框架的格式验证，假如只是验证都是字母也罢了，太简单了，不怎么耗性能，如果是验证是否身份证，这性能消耗大，你可以隔170ms才验证一次。这时就需要这个东西。或者你这个是自动完全，需要将已有的输入数据往后端拉一个列表，频繁的交互，后端肯定耗不起，这时也需要这个，如隔350ms。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, delay</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> timeout;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"清除"</span>,timeout,e.target.value)</span><br><span class="line">        clearTimeout(timeout);</span><br><span class="line">        <span class="keyword">var</span> context = <span class="keyword">this</span>, args = <span class="built_in">arguments</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"新的"</span>,timeout, e.target.value)</span><br><span class="line">        timeout = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"----"</span>)</span><br><span class="line">          func.apply(context, args);</span><br><span class="line">        &#125;,delay)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> validate = debounce(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"change"</span>, e.target.value, <span class="keyword">new</span> <span class="built_in">Date</span><span class="number">-0</span>)</span><br><span class="line">&#125;, <span class="number">380</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定监听</span></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">"input"</span>).addEventListener(<span class="string">'input'</span>, validate);</span><br></pre></td></tr></table></figure>
<p>这个保证了正常的用户每输入1，2个字符就能触发一次。如果用户是输入法狂魔，也可以狠制他每输入3～6个字符触发一次。</p>
<p>这个方法的重点是，它在用户不触发事件的时，才触发动作，并且抑制了本来在事件中要执行的动作。</p>
<p>其他应用场合：提交按钮的点击事件。</p>
<h4 id="节流"><a href="#节流" class="headerlink" title="节流"></a>节流</h4><p>再看节流，throttle。节流的概念可以想象一下水坝，你建了水坝在河道中，不能让水流动不了，你只能让水流慢些。换言之，你不能让用户的方法都不执行。如果这样干，就是debounce了。为了让用户的方法在某个时间段内只执行一次，我们需要保存上次执行的时间点与定时器。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'panel'</span> <span class="attr">style</span>=<span class="string">"background:red;width:200px;height:200px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, threshhold</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> timeout</span><br><span class="line">  <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">  <span class="keyword">var</span> threshhold = threshhold || <span class="number">160</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> context = <span class="keyword">this</span>, args = <span class="built_in">arguments</span>, curr = <span class="keyword">new</span> <span class="built_in">Date</span>() - <span class="number">0</span></span><br><span class="line">    clearTimeout(timeout)<span class="comment">//总是干掉事件回调</span></span><br><span class="line">    <span class="keyword">if</span> (curr - start &gt;= threshhold) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"now"</span>, curr, curr - start)<span class="comment">//注意这里相减的结果，都差不多是160左右</span></span><br><span class="line">          fn.apply(context, args) <span class="comment">//只执行一部分方法，这些方法是在某个时间段内执行一次</span></span><br><span class="line">          start = curr</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//让方法在脱离事件后也能执行一次</span></span><br><span class="line">      timeout = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          fn.apply(context, args)</span><br><span class="line">      &#125;, threshhold);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mousemove = throttle(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.pageX, e.pageY)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定监听</span></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">"#panel"</span>).addEventListener(<span class="string">'mousemove'</span>, mousemove);</span><br></pre></td></tr></table></figure>
<p>函数节流会用在比input, keyup更频繁触发的事件中，如resize, touchmove, mousemove, scroll。throttle 会强制函数以固定的速率执行。因此这个方法比较适合应用于动画相关的场景。</p>
<p>如果还是不能完全体会 debounce 和 throttle 的差异，可以到 这个页面 看一下两者可视化的比较。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/04/koa2中间件原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/koa2中间件原理/" itemprop="url">koa2中间件原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-04T11:25:15+08:00">
                2018-05-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="今天说说koa2中next的原理"><a href="#今天说说koa2中next的原理" class="headerlink" title="今天说说koa2中next的原理"></a>今天说说koa2中next的原理</h2><h3 id="举个栗子🌰"><a href="#举个栗子🌰" class="headerlink" title="举个栗子🌰"></a>举个栗子🌰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = &#123;</span><br><span class="line">    middleware: [],</span><br><span class="line">    callback(ctx) &#123; <span class="comment">//最终请求结束调用</span></span><br><span class="line">        <span class="built_in">console</span>.log(ctx)</span><br><span class="line">    &#125;,</span><br><span class="line">    use(fn) &#123;</span><br><span class="line">        <span class="comment">// 逻辑</span></span><br><span class="line">        <span class="keyword">this</span>.middleware.push(fn)</span><br><span class="line">    &#125;,</span><br><span class="line">    start(ctx) &#123;</span><br><span class="line">        <span class="comment">// 逻辑</span></span><br><span class="line">        <span class="keyword">const</span> reducer = <span class="function">(<span class="params">next, fn , i</span>) =&gt;</span> () =&gt; &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(fn, next)</span><br><span class="line">            fn(ctx, next)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从右侧遍历，最后拿到最栈顶的next，并从栈顶到栈尾形成next链</span></span><br><span class="line">        <span class="keyword">const</span> q = <span class="keyword">this</span>.middleware.reduceRight(reducer, <span class="keyword">this</span>.callback.bind(<span class="keyword">this</span>, ctx)) <span class="comment">//没处理异步</span></span><br><span class="line">        <span class="built_in">console</span>.log(q)</span><br><span class="line">        <span class="comment">// 开始执行栈顶</span></span><br><span class="line">        q()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">app.use(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.name = <span class="string">'huangwei'</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; use name'</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; use name'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.age = <span class="number">20</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; use age'</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; use age'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`&gt;&gt; <span class="subst">$&#123;ctx.name&#125;</span> is <span class="subst">$&#123;ctx.age&#125;</span> years old`</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`&lt;&lt; <span class="subst">$&#123;ctx.name&#125;</span> is <span class="subst">$&#123;ctx.age&#125;</span> years old`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.start(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// q</span></span><br><span class="line">() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fn, next)</span><br><span class="line">    fn(ctx, next)</span><br><span class="line">&#125;</span><br><span class="line">(ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.name = <span class="string">'huangwei'</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; use name'</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; use name'</span>)</span><br><span class="line">&#125;</span><br><span class="line">() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fn, next)</span><br><span class="line">    fn(ctx, next)</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt; use name</span><br><span class="line"></span><br><span class="line">(ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.age = <span class="number">20</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; use age'</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; use age'</span>)</span><br><span class="line">&#125;</span><br><span class="line">() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fn, next)</span><br><span class="line">    fn(ctx, next)</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt; use age</span><br><span class="line"></span><br><span class="line">(ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`&gt;&gt; <span class="subst">$&#123;ctx.name&#125;</span> is <span class="subst">$&#123;ctx.age&#125;</span> years old`</span>)</span><br><span class="line">    next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`&lt;&lt; <span class="subst">$&#123;ctx.name&#125;</span> is <span class="subst">$&#123;ctx.age&#125;</span> years old`</span>)</span><br><span class="line">&#125;</span><br><span class="line">ƒ callback(ctx) &#123; <span class="comment">//最终请求结束调用</span></span><br><span class="line">    <span class="built_in">console</span>.log(ctx)</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt; huangwei is <span class="number">20</span> years old</span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">name</span>: <span class="string">"huangwei"</span>, <span class="attr">age</span>: <span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line">&lt;&lt; huangwei is <span class="number">20</span> years old</span><br><span class="line">&lt;&lt; use age</span><br><span class="line">&lt;&lt; use name</span><br></pre></td></tr></table></figure>
<h4 id="分析栗子🌰"><a href="#分析栗子🌰" class="headerlink" title="分析栗子🌰"></a>分析栗子🌰</h4><p>先看一张图</p>
<p><img src="https://raw.githubusercontent.com/schacker/image-folder/master/blog/img/koa2-next.png" alt="中间件是怎么串起来的"></p>
<p>首先我们看到上面有黄色的模块，这个我们定义为我们刚刚使用的中间件默认执行函数callback（D），三个中间件一次为A、B、C，那么我们下面的两个条状柱体是reduceRight中reducer回调函数的前两个参数<br>那我们看到的应该是这样的。</p>
<p>第一次回调分别是D、C，因为我们后面传入了默认值D，第二次是返回第一次reducer返回的函数，第三次是返回第二次reducer返回的函数，以此类推，就生成了这个图。然后就形成了联调，那么最后拿到的q就是最后的A-&gt;B的函数，这样的话就形成链条（链表），然后我们顺着缕缕接下来的过程。A执行的时候，A里面包含next，而这个next正好是B，B执行的时候，B里面next正好是C，C执行的时候，C里面的next正好是D，好，这个时候D执行完，往上回溯，执行C的next后面的逻辑，这个时候C执行结束，到B的next后面逻辑，最后到A的next后面逻辑，最后就形成了这个神奇的next串</p>
<p>注：这里是没有考虑异步</p>
<h3 id="直接koa2"><a href="#直接koa2" class="headerlink" title="直接koa2"></a>直接koa2</h3><p>上面是模拟koa2，下面直接使用koa2</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> one = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; one'</span>);</span><br><span class="line">    <span class="comment">// return next();</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; one'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> two = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; two'</span>);</span><br><span class="line">    <span class="comment">// return next();</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; two'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> three = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; three'</span>);</span><br><span class="line">    <span class="comment">// return next();</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; three'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(one);</span><br><span class="line">app.use(two);</span><br><span class="line">app.use(three);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; one</span><br><span class="line">&gt;&gt; two</span><br><span class="line">&gt;&gt; three</span><br><span class="line">&lt;&lt; three</span><br><span class="line">&lt;&lt; two</span><br><span class="line">&lt;&lt; one</span><br></pre></td></tr></table></figure>
<p><code>当然这和我们的next放的位置有关系
放最后就不会出现回溯，最前面的话，表面看就只有回溯</code></p>
<p>如果打开上面<code>return</code><br>则输出结果为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; one</span><br><span class="line">&gt;&gt; two</span><br><span class="line">&gt;&gt; three</span><br></pre></td></tr></table></figure>
<p>这样的话可以阻止会面的回溯，通常也会这样写，当然也有特殊case中需要用到这个特性，比如<br>记录请求的总耗时</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.use( <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">const</span> &#123; request, response &#125; = ctx</span><br><span class="line"></span><br><span class="line">    ctx.request.uuid = ctx.headers.UNIQID || uuid()</span><br><span class="line">    ctx.request.sequence = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">        process.emit(<span class="string">'log.access'</span>, &#123;</span><br><span class="line">        request, response, startTime, endTime, ctx,</span><br><span class="line">        uuid: ctx.request.uuid,</span><br><span class="line">        sequence: ctx.request.sequence,</span><br><span class="line">        timeCost: endTime - startTime</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>关于上面的运行机制及原理，我们分析一波<br>我们关注下application.js<br><a href="https://github.com/koajs/koa/blob/master/lib/application.js" target="_blank" rel="noopener">application传送门</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">use(fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</span><br><span class="line">    <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</span><br><span class="line">      deprecate(<span class="string">'Support for generators will be removed in v3. '</span> +</span><br><span class="line">                <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</span><br><span class="line">                <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span>);</span><br><span class="line">      fn = convert(fn);</span><br><span class="line">    &#125;</span><br><span class="line">    debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</span><br><span class="line">    <span class="keyword">this</span>.middleware.push(fn);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>重点关注<code>this.middleware.push(fn)</code>，向我们的middleware栈push中间件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">callback() &#123;</span><br><span class="line">    <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.listenerCount(<span class="string">'error'</span>)) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.handleRequest(ctx, fn);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handleRequest;</span><br><span class="line">  &#125;</span><br><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">    res.statusCode = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class="line">    <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</span><br><span class="line">    onFinished(res, onerror);</span><br><span class="line">    <span class="keyword">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>重点关注<br><code>const fn = compose(this.middleware)</code><br>和handleRequest中的<br><code>return fnMiddleware(ctx).then(handleResponse).catch(onerror)</code><br>那重点就在compose，compose函数返回的是一个promise</p>
<p><a href="https://github.com/koajs/compose/blob/master/index.js" target="_blank" rel="noopener">compose传送门</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span> (<span class="params">middleware</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(middleware)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware stack must be an array!'</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fn <span class="keyword">of</span> middleware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware must be composed of functions!'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @param &#123;Object&#125; context</span></span><br><span class="line"><span class="comment">   * @return &#123;Promise&#125;</span></span><br><span class="line"><span class="comment">   * @api public</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// last called middleware #</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (i &lt;= index) <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'next() called multiple times'</span>))</span><br><span class="line">      index = i</span><br><span class="line">      <span class="keyword">let</span> fn = middleware[i]</span><br><span class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</span><br><span class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(context, <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</span><br><span class="line">        &#125;))</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们重点关注这个<code>dispatch</code>，这样结合上面的看会发现形成了一个递归链，这样也就解释了为什么会出现回溯</p>
<p>当next为空，直接返回，所以也就解释了为什么没有next不会向下走。<br>假设我们执行到第一个fn了，这个时候fn是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fn = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt; one'</span>);</span><br><span class="line">    <span class="comment">// return next();</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&lt;&lt; one'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>next</code>对应 <code>function next(){return dispatch(i+1)}</code>，所以就进入到<code>dispatch(i+1)</code>下一个中间件了，以此类推。<br>核心就是dispatch，最后结束就是next不存在，然后开始依次回溯到里层，所以执行顺序是越先注册越后执行。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/23/macrotasks-microtasks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="schacker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜鸟的逆袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/23/macrotasks-microtasks/" itemprop="url">macrotasks_microtasks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-23T21:10:23+08:00">
                2018-04-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>放个面试题，抛个砖：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> interval = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'setInterval'</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'setTimeout 1'</span>)</span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'promise 3'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'promise 4'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'setTimeout 2'</span>)</span><br><span class="line">        <span class="built_in">Promise</span>.resolve()</span><br><span class="line">            .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'promise 5'</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'promise 6'</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                clearInterval(interval)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'promise 1'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'promise 2'</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>不着急揭晓答案，先分析</p>
<p>首先知晓：</p>
<blockquote>
<p>js是单线程语言</p>
</blockquote>
<pre><code>也就是说一次就只能做一件事情。多数的网站不需要大量计算，程序花费的时间主要集中在磁盘 I/O 和网络 I/O 上面,虽然SSD读取很快，但和CPU处理指令的速度比起来也不在一个数量级上，而且网络上一个数据包来回的时间更慢（注意过游戏的延迟吗）

so: 一些cpu直接执行的任务就成了优先执行主线任务，然后需要io返回数据的任务就成了等待被执行的任务，所以才会有同步任务（synchronous）和异步任务（asynchronous）之分
</code></pre><h4 id="同步任务："><a href="#同步任务：" class="headerlink" title="同步任务："></a>同步任务：</h4><pre><code>在主线程上排队执行的任务，前一个任务执行完毕，才能执行后一个任务；
</code></pre><h4 id="异步任务："><a href="#异步任务：" class="headerlink" title="异步任务："></a>异步任务：</h4><pre><code>不进入主线程、而进入”任务队列”（task queue）的任务，只有”任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。
</code></pre><h4 id="总之："><a href="#总之：" class="headerlink" title="总之："></a>总之：</h4><pre><code>只要主线程空了，就会去读取”任务队列”，这就是JavaScript的运行机制

Microtasks Macrotasks
任务队列不止一个，还有 microtasks 和 macrotasks
</code></pre><ul>
<li>microtasks:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">process.nextTick</span><br><span class="line">promise</span><br><span class="line"><span class="built_in">Object</span>.observe</span><br><span class="line">MutationObserver</span><br></pre></td></tr></table></figure>
<ul>
<li>macrotasks:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setTimeout</span><br><span class="line">setInterval</span><br><span class="line">setImmediate</span><br><span class="line">I/O</span><br><span class="line">UI渲染</span><br></pre></td></tr></table></figure>
<ul>
<li><p>whatwg规范：<a href="https://html.spec.whatwg.org/multipage/webappapis.html#task-queue" target="_blank" rel="noopener">https://html.spec.whatwg.org/multipage/webappapis.html#task-queue</a></p>
<p>  一个事件循环(event loop)会有一个或多个任务队列(task queue)<br>  task queue 就是 macrotask queue<br>  每一个 event loop 都有一个 microtask queue<br>  task queue == macrotask queue != microtask queue<br>  一个任务 task 可以放入 macrotask queue 也可以放入 microtask queue 中<br>  理解了这些定义之后，再看执行原理：</p>
<p>  事件循环的顺序，决定了JavaScript代码的执行顺序。它从script(整体代码)开始第一次循环。之后全局上下文进入函数调用栈。直到调用栈清空(只剩全局)，然后执行所有的micro-task。当所有可执行的micro-task执行完毕之后。循环再次从macro-task开始，找到其中一个任务队列执行完毕，然后再执行所有的micro-task，这样一直循环下去。</p>
<p>  还要注意一点：</p>
<p>  包裹在一个 script 标签中的js代码也是一个 task 确切说是 macrotask。</p>
<p>  所以文首面试题的答案为：</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">start </span><br><span class="line">promise <span class="number">1</span> </span><br><span class="line">promise <span class="number">2</span> </span><br><span class="line">setInterval </span><br><span class="line">setTimeout <span class="number">1</span> </span><br><span class="line">promise <span class="number">3</span> </span><br><span class="line">promise <span class="number">4</span> </span><br><span class="line">setInterval </span><br><span class="line">setTimeout <span class="number">2</span> </span><br><span class="line">promise <span class="number">5</span> </span><br><span class="line">promise <span class="number">6</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>简单来讲，整体的js代码这个macrotask先执行，同步代码执行完后有microtask执行microtask，没有microtask执行下一个macrotask，如此往复循环至结束</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">schacker</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">schacker</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
